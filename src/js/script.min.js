var b=document.getElementById("b");var c=b.getContext("2d");var threshold=0;var vertical=false;var invert=false;var drag=false;var dragRect={};var img=new Image();function process(d){toggleLoading(true);f=d.files[0];if(!f.type.match("image.*")){return alert("Not an image")}var a=new FileReader();a.onload=fileReadComplete;a.readAsDataURL(f)}var fileReadComplete=function(a){col=document.getElementById("mainCol");img.src=a.target.result;(function(){if(img.complete){b.width=img.width;b.height=img.height;c.drawImage(img,0,0);start()}else{setTimeout(arguments.callee,50)}})()};function start(){toggleLoading(true);setTimeout(function(){c.drawImage(img,0,0);threshold=parseInt(document.getElementById("threshold").value);threshold=100-threshold;vertical=document.getElementById("vertical").checked;invert=document.getElementById("invert").checked;if(vertical){pixelSortV()}else{pixelSortH()}toggleLoading(false)},10)}function pixelSortH(){for(var h=0;h<b.height;h++){var g=c.getImageData(0,h,b.width,1);var e=g.data;var j=getPixelsArray(e);var i=0;var a=findValueLess(j,h,threshold,i);while(i<b.width){var d=j.splice(i,a-i);d.sort(invert?simpleMeanSortInverted:simpleMeanSort);j.splice.apply(j,[i,0].concat(d));i=a;a=findValueLess(j,h,threshold,i+1)}setDataFromPixelsArray(e,j);c.putImageData(g,0,h)}}function pixelSortV(){for(var e=0;e<b.width;e++){var h=c.getImageData(e,0,1,b.height);var g=h.data;var j=getPixelsArray(g);var i=0;var a=findValueLess(j,e,threshold,i);while(i<b.height){var d=j.splice(i,a-i);d.sort(invert?simpleMeanSortInverted:simpleMeanSort);j.splice.apply(j,[i,0].concat(d));i=a;a=findValueLess(j,e,threshold,i+1)}setDataFromPixelsArray(g,j);c.putImageData(h,e,0)}}function getPixelsArray(d){var e=[],g;for(var a=0;a<d.length/4;a++){g=a*4;e.push({r:d[g+0],g:d[g+1],b:d[g+2]})}return e}function simpleMeanSort(e,d){var g=(e.r+e.g+e.b)/3;var h=(d.r+d.g+d.b)/3;return g<h?-1:(g>h?1:0)}function simpleMeanSortInverted(e,d){var g=(e.r+e.g+e.b)/3;var h=(d.r+d.g+d.b)/3;return g>h?-1:(g<h?1:0)}function setDataFromPixelsArray(d,g){var e;for(var a=0;a<g.length;a++){e=a*4;d[e+0]=g[a].r;d[e+1]=g[a].g;d[e+2]=g[a].b}}function findValue(h,e,d,g){for(var a=g;a<h.length;a++){if(h[a].r===d.r&&h[a].g===d.g&&h[a].b===d.b){return a}}return h.length}function findValueLess(h,e,d,g){for(var a=g;a<h.length;a++){if((h[a].r+h[a].g+h[a].b)/3<d){return a}}return h.length}function addClass(d,a){if(d.classList){d.classList.add(a)}else{if(!hasClass(d,a)){d.className+=" "+a}}}function removeClass(e,d){if(e.classList){e.classList.remove(d)}else{if(hasClass(e,d)){var a=new RegExp("(\\s|^)"+d+"(\\s|$)");e.className=e.className.replace(a," ")}}}function downloadImage(e){var d=document.getElementById("downloadMe");var g=b.toDataURL("image/jpeg");if(e===""){e="Pix-L SortR "+new Date().toString()}d.download=e;d.href=g;d.click()}function draw(){c.fillRect(dragRect.startX,dragRect.startY,dragRect.w,dragRect.h);console.log(dragRect.startX);console.log(dragRect.startY)}function toggleLoading(a){var e="none";var g=document.getElementById("loading").style.display;if(a){e="block"}if(e!=g){document.getElementById("loading").style.display=e}}$(document).on("click",".browse",function(){var a=$(this).parent().parent().parent().find(".file");a.trigger("click")});$(document).on("change",".file",function(){$(this).parent().find(".form-control").val($(this).val().replace(/C:\\fakepath\\/i,""))});